<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EduBalance v2</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
<style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f0f4f8; margin:0; padding:20px; }
    h1 { text-align:center; color:#1f3c88; }
    .tabs { display:flex; justify-content:center; margin-bottom:20px; gap:10px; }
    .tabs button { background:#e0e7ff; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; transition:0.3s; }
    .tabs button.active { background:#1f3c88; color:white; }
    .tab { display:none; }
    .tab.active { display:block; }
    .card { background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
    input, select, button { width:100%; padding:10px; margin:8px 0; border-radius:8px; border:1px solid #ccc; box-sizing:border-box; font-size:16px; }
    button { background:#1f3c88; color:white; border:none; cursor:pointer; transition:0.3s; }
    button:hover { background:#152a5a; }
    .metric { margin-top:10px; font-weight:bold; font-size:18px; text-align:center; }
    p.message { margin-top:10px; text-align:center; font-weight:bold; }
</style>
</head>

<body>
<h1>ğŸ“ EduBalance v2</h1>

<div class="card">
  <label for="lang">ğŸŒ Dil / Language / Langue:</label>
  <select id="lang">
    <option value="Azerbaycan">Azerbaycan</option>
    <option value="English">English</option>
    <option value="FranÃ§ais">FranÃ§ais</option>
  </select>
</div>

<div class="card">
  <label for="username">ğŸ‘¤ Ä°stifadÉ™Ã§i adÄ±:</label>
  <input type="text" id="username" placeholder="AdÄ±nÄ±zÄ± daxil edin...">
</div>

<div class="tabs">
  <button class="active" onclick="showTab('profile', this)">Profil Yarat</button>
  <button onclick="showTab('daily', this)">GÃ¼nlÃ¼k Statistika</button>
  <button onclick="showTab('study', this)">DÉ™rs SessiyasÄ±</button>
</div>

<div id="profile" class="tab active card">
  <label>ğŸ¯ HÉ™dÉ™f Ä°mtahan:</label>
  <select id="targetExam">
    <option>BuraxÄ±lÄ±ÅŸ</option>
    <option>Blok</option>
    <option>Magistratura</option>
    <option>YÃ–S/SAT</option>
    <option>MÄ°Q</option>
    <option>DigÉ™r</option>
  </select>
  <button onclick="createProfile()">â• Profil Yarat / YenilÉ™</button>
  <p id="profileMsg" class="message"></p>
</div>

<div id="daily" class="tab card">
  <label>ğŸŒ™ Yuxu (Saat):</label>
  <input type="number" id="sleep" min="0" max="12" step="0.1" value="8">
  <label>ğŸ’§ Su (Litr):</label>
  <input type="number" id="water" min="0" max="5" step="0.1" value="1.5">
  <p class="metric" id="moodMetric">TÉ™xmin edilÉ™n Æhval: -</p>
  <button onclick="saveDaily()">ğŸ’¾ Yadda saxla (Daily)</button>
  <p id="dailyMsg" class="message"></p>
</div>

<div id="study" class="tab card">
  <label>ğŸ“š FÉ™nni seÃ§in:</label>
  <select id="subject">
    <option>AzÉ™rbaycan dili</option>
    <option>Riyaziyyat</option>
    <option>Ä°ngilis dili</option>
    <option>Fizika</option>
    <option>DigÉ™r</option>
  </select>
  <label>â±ï¸ (dÉ™qiqÉ™):</label>
  <input type="number" id="duration" min="10" max="300" value="45">
  <button onclick="saveStudy()">ğŸ“– Yadda saxla (Study)</button>
  <p id="studyMsg" class="message"></p>
</div>

<script>
  // --- Supabase connection ---
  const SUPABASE_URL = "YOUR_SUPABASE_URL";
  const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

  // â— Æsas dÃ¼zÉ™liÅŸ: "supabase" adÄ±nÄ± dÉ™yiÅŸirik ki, qlobal obyektlÉ™ toqquÅŸmasÄ±n
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  let userId = null;

  function showTab(tabId, btn) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tabId).classList.add('active');

    document.querySelectorAll('.tabs button').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  async function getProfileId(username) {
    const { data, error } = await sb
      .from('students_profiles')
      .select('id')
      .eq('username', username)
      .maybeSingle();

    if (error) {
      console.error(error);
      return null;
    }
    return data ? data.id : null;
  }

  async function ensureUserId() {
    const username = document.getElementById('username').value.trim();
    if (!username) {
      alert("Ä°stifadÉ™Ã§i adÄ±nÄ± daxil edin!");
      return false;
    }
    if (!userId) userId = await getProfileId(username);
    if (!userId) {
      alert("Profil tapÄ±lmadÄ±. ÆvvÉ™l Profil Yarat!");
      return false;
    }
    return true;
  }

  function calcMood(sleep, water) {
    const score = (sleep >= 7 && sleep <= 9 ? 60 : 30) + (water >= 2 ? 40 : 15);
    const mood = score >= 90 ? "Æla ğŸ”¥" : (score >= 60 ? "Normal ğŸ˜Š" : "YorÄŸun ğŸ˜´");
    return { score, mood };
  }

  function updateMoodUI() {
    const sleep = parseFloat(document.getElementById('sleep').value || "0");
    const water = parseFloat(document.getElementById('water').value || "0");
    const { mood } = calcMood(sleep, water);
    document.getElementById('moodMetric').innerText = TÉ™xmin edilÉ™n Æhval: ${mood};
  }

  // Input dÉ™yiÅŸÉ™ndÉ™ mood avtomatik yenilÉ™nsin (optional, amma rahatdÄ±r)
  document.getElementById('sleep').addEventListener('input', updateMoodUI);
  document.getElementById('water').addEventListener('input', updateMoodUI);
  updateMoodUI();

  async function createProfile() {
    const username = document.getElementById('username').value.trim();
    const lang = document.getElementById('lang').value;
    const target = document.getElementById('targetExam').value;

    if (!username) {
      alert("Ä°stifadÉ™Ã§i adÄ±nÄ± daxil edin!");
      return;
    }

    const { error } = await sb
      .from('students_profiles')
      .upsert(
        { username, language: lang, target_exam: target, updated_at: new Date().toISOString() },
        { onConflict: 'username' }
      );

    if (error) {
      document.getElementById('profileMsg').innerText = "Profil yazÄ±lmadÄ±: " + error.message;
      return;
    }

    userId = await getProfileId(username);
    document.getElementById('profileMsg').innerText = "Profil yadda saxlanÄ±ldÄ± âœ…";
  }

  async function saveDaily() {
    const ok = await ensureUserId();
    if (!ok) return;

    const sleep = parseFloat(document.getElementById('sleep').value);
    const water = parseFloat(document.getElementById('water').value);

    const { score, mood } = calcMood(sleep, water);
    document.getElementById('moodMetric').innerText = TÉ™xmin edilÉ™n Æhval: ${mood};

    const { error } = await sb.from('daily_stats').insert({
      user_id: userId,
      stat_date: new Date().toISOString().split('T')[0],
      sleep_hours: sleep,
      water_liters: water,
      score: score,
      mood: mood,
      created_at: new Date().toISOString()
    });

    document.getElementById('dailyMsg').innerText =
      error ? ("Daily yazÄ±lmadÄ±: " + error.message) : "MÉ™lumatlar uÄŸurla qeyd olundu!";
  }

  async function saveStudy() {
    const ok = await ensureUserId();
    if (!ok) return;

    const subject = document.getElementById('subject').value;
    const duration = parseInt(document.getElementById('duration').value, 10);

    const { error } = await sb.from('study_sessions').insert({
      user_id: userId,
      session_date: new Date().toISOString().split('T')[0],
      subject: subject,
      duration_min: duration,
      created_at: new Date().toISOString()
    });

    document.getElementById('studyMsg').innerText =
      error ? ("Study yazÄ±lmadÄ±: " + error.message) : ${subject} - qeyd olundu âœ…;
  }
</script>
</body>
</html>
